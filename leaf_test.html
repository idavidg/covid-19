
<!DOCTYPE html>
<html>
<head>
	
	<title>Travel viz -- leaf</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	
</head>
<body>


<div id="mapid" style="width: 1000px; height: 600px;"></div>
<div id="date_stamp"></div>
<div id="day_stamp"></div>
<div id="id_num"></div>

<script>

    var start_location = [20, 20]
    var map = L.map('mapid').setView(start_location, 13).setZoom(2);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1
    }).addTo(map);

    function load_json(url, callback) {
        var xobj = new XMLHttpRequest();
        //xobj.addEventListener("loadend", function(ev) { alert("loadend" + ev.loaded + " of " + ev.total) });
        xobj.overrideMimeType("application/json");
        xobj.open('GET', url, true); 
        xobj.onreadystatechange = function () {
              if (xobj.readyState == 4 && xobj.status == "200") {
                callback(xobj.responseText);
              }
        };
        xobj.send(null);
    }
    
    var map_data
    function load_chlo_map(response) {
        map_data = JSON.parse(response);
        //mapGeoJson(map_data)
    }


    // get color depending on scalerank
    function getColor(d) {
        if (typeof d == 'undefined') {
            return '#FFEDA0'
        }
        return d > 10000 ? '#800026' :
                d > 2000  ? '#BD0026' :
                d > 500  ? '#E31A1C' :
                d > 100  ? '#FC4E2A' :
                d > 50   ? '#FD8D3C' :
                d > 20   ? '#FEB24C' :
                d > 10   ? '#FED976' :
                            '#FFEDA0';
    }
    function style(feature) {
        return {
            weight: 2,
            opacity: 1,
            color: 'white',
            dashArray: '3',
            fillOpacity: 0.7,
            fillColor: getColor(feature.properties.count)
            //fillColor: getColor(feature.properties.scalerank)
        };
    }


	var geojson;
    function mapGeoJson(map_data) {
        if (typeof geojson != 'undefined') {
            geojson.remove();
        }
        geojson = L.geoJson(map_data, {
            style: style
            //style: style,
            //onEachFeature: onEachFeature
        }).addTo(map);
        geojson.bringToBack()
    }

    time_data_url = 'https://raw.githubusercontent.com/idavidg/covid-19/master/time_series_19-covid-Confirmed.json'
    var time_data
    load_json(time_data_url, load_time_data) 

    chlo_url = 'https://raw.githubusercontent.com/necsi/database/master/mapping-data/ne_count18.json' 
    load_json(chlo_url, load_chlo_map) 

    travel_url = 'https://raw.githubusercontent.com/idavidg/covid-19/master/NECSI-TRAVELDATAVIZ-20200309-1846.json'
    load_json(travel_url, load_animation) 

    function load_time_data(response) {
        time_data = JSON.parse(response);
    }

    var color_map = {'China':'red', 'Italy':'blue', 'Iran':'green'}
        //, 'Singapore', 'Thailand', 'Japan', 'Taiwan', 'Malaysia',
        //'France', 'Iran', 'Indonesia', 'Spain', 'Latvia',
        //'Germany', 'Egypt', 'United Arab Emirates', 'Austria',
        //'Switzerland', 'USA/WA'

    function draw_poly(travel_point, i){

        if (typeof time_data != 'undefined') {
            var changed = false
            for (var t in time_data) {
                var data_point = time_data[t];
                if (data_point.day_of_year == travel_point.day_of_year) {
                    for (var m in map_data.features) {
                        var map_point = map_data.features[m];
                        if ((map_point.properties.name == 'China') ||
                            (map_point.properties.iso == 'China')) {
                            alert('china')
                        }
                        if ((data_point['Country/Region'] == 'China') ||
                            (data_point['Country/Region'] == 'China')) {
                            alert('china 1')
                        }
                        if ((map_point.properties.name == data_point['Country/Region']) ||
                            (map_point.properties.iso == data_point['Country/Region'])) {
                            map_point.properties.count = data_point['count'] 
                            //map_point.properties.scalerank = data_point['count'] 
                        }
                    }
                    changed = true
                }
            }
            if (changed) {
                //map.invalidateSize()
                //geojson.refresh()
                mapGeoJson(map_data)
            }
        }

        //AGE,SEX,NUM,TO,FROM,DATE,TO_lat,TO_lon,FROM_lat,FROM_lon
        var points =  [ [travel_point.FROM_lat, travel_point.FROM_lon],
                        [travel_point.TO_lat, travel_point.TO_lon] ]
        date_stamp.innerHTML = 'date: ' + travel_point.date_string;
        day_stamp.innerHTML = 'day from first traveler: ' + travel_point.day_of_year;
        id_num.innerHTML = 'id: ' + i
        color = color_map[travel_point.FROM]
        if (typeof color == 'undefined') {
            color = 'purple'
        }
        var polygon = L.polygon(points , {weight: 1, opacity: 0.5, color: color}).addTo(map);
        L.circle(points[1], 50, {
            color: color,
            fillColor: '#f03',
            fillOpacity: 0.5
        }).addTo(map)
    }

    var travel_data
    function load_animation(response) {
        travel_data = JSON.parse(response);

        for (var i in travel_data){
            var travel_point = travel_data[i];
            setTimeout( draw_poly, travel_point.day_of_year * 200, travel_point, i);
        }
    };

</script>



</body>
</html>

